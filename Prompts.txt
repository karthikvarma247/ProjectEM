data_management_prompt = '''1** designed to extract the necessary information for determining the **MDM Data Management Level** from a medical record, based on AMA guidelines. This prompt focuses on identifying key elements in the categories of **Lab Orders, Test Reviews, Independent Interpretations, External Data, and Independent Historian**:

---

### **Prompt 1: Information Extraction for MDM Data Management**
**Role**: You are a medical coding expert analyzing a patient's medical record to extract specific details for MDM level calculation under AMA guidelines.  
**Task**: Identify and list ONLY the following elements from the medical record:  

#### **1. Lab Orders Placed**  
- **Definition**: Tests ordered during the encounter (e.g., blood tests, imaging).  
- **Extract**: List each **unique test ordered** (e.g., "CBC," "Lipid Panel," "CT Chest").  
- **Note**: Ignore duplicates (e.g., 2x CBC = 1 unique test).  

#### **2. Results Reviewed**  
- **Definition**: Results of tests **reviewed** during the encounter (e.g., lab results, precision tests, imaging reports).  
- **Extract**: List each **unique test reviewed** (e.g., "Genetic Test BRCA1," "COVID-19 PCR Result").  

#### **3. Independent Interpretations**  
- **Definition**: Tests where the provider **personally analyzed raw data** (e.g., EKG tracings, biopsy slides) instead of relying solely on another clinician's report.  
- **Extract**: List tests with **explicit documentation** of independent interpretation (e.g., "I reviewed the MRI images myself").  

#### **4. External Data Reviewed**  
- **Definition**: Data obtained from **external sources** (e.g., records from another hospital, specialist consult notes).  
- **Extract**: List each **unique external source** (e.g., "Dr. Smith's Cardiology Report," "ABC Lab Records").  

#### **5. Independent Historian**  
- **Definition**: History obtained from a **non-family/caregiver source** (e.g., paramedic, social worker) due to patient incapacity.  
- **Extract**: State `true` if present (with role, e.g., "EMT history"), else `false`.  

---

### **Output Format Requirements**  
Return a **strict JSON object** with these keys:  
```json
{
  "lab_orders_placed": ["test1", "test2", ...],
  "results_reviewed": ["test1", "test2", ...],
  "independent_interpretations": ["test1", "test2", ...],
  "external_data_reviewed": ["source1", "source2", ...],
  "independent_historian": "true/false with role (if true)"
}
```  

### **Medical Record Input**  
```  
[Insert patient's medical record text here]  
```  

---

### **Example**  
**Medical Record Snippet**:  
> "Ordered CBC and liver enzymes. Reviewed prior genetic test (OncoType DX) and chest X-ray from City Hospital. Interpreted EKG strips directly. History obtained from EMS due to patient confusion."  

**Output**:  
```json
{
  "lab_orders_placed": ["CBC", "Liver Enzymes"],
  "results_reviewed": ["OncoType DX", "Chest X-ray"],
  "independent_interpretations": ["EKG Strips"],
  "external_data_reviewed": ["City Hospital Records"],
  "independent_historian": "true (EMS)"
}
```

---

### **Key Instructions**  
- **Be specific**: Use exact test/source names from the record.  
- **Exclude non-relevant data**: Ignore HPI, Assessment/Plan, or non-test-related notes.  
- **No scoring/analysis**: Only extract facts. Scoring happens in Prompt 2.  

After running this prompt, feed the JSON output into **Prompt 2** (which contains AMA scoring rules) to determine the final MDM level for Data Management.

'''

data_evaluation_prompt= '''

# AMA MDM COMPLEXITY DETERMINATION TABLE - IMPROVED PROMPT

## CRITICAL EVALUATION RULES
1. **STRICT CATEGORY REQUIREMENTS**: Each category has minimum thresholds that MUST be met exactly
2. **NO PARTIAL CREDIT**: If minimum requirements aren't met, that category CANNOT be counted
3. **HIERARCHICAL CLASSIFICATION**: Evaluate ALL levels, report ALL that qualify (High > Moderate > Low > Straightforward)
4. **EXPLICIT DOCUMENTATION REQUIRED**: Only count what is explicitly documented, not implied

---

## COMPLEXITY LEVELS & REQUIREMENTS

### STEP 1: HIGH COMPLEXITY (Extensive)
**Requires ≥2 categories from the following 3:**

**Category 1: Tests, Documents, or Independent Historian(s)**
- **MINIMUM REQUIREMENT**: Must have ANY combination of **EXACTLY 3 OR MORE** from:
  - Review of prior external note(s) from each unique source
  - Review of the result(s) of each unique test
  - Ordering of each unique test
  - Assessment requiring an independent historian(s)
- **⚠️ CRITICAL**: If fewer than 3 items are met, DO NOT count Category 1 at all

**Category 2: Independent Interpretation**
- Independent interpretation of tests performed by another physician/qualified healthcare professional (not separately reported)

**Category 3: External Discussion**
- Discussion of management or test interpretation with external physician/qualified healthcare professional/appropriate source (not separately reported)

---

### STEP 2: MODERATE COMPLEXITY
**Requires ≥1 category from the following 3:**

**Category 1: Tests, Documents, or Independent Historian(s)**
- **MINIMUM REQUIREMENT**: Must have ANY combination of **EXACTLY 3 OR MORE** from:
  - Review of prior external note(s) from each unique source
  - Review of the result(s) of each unique test
  - Ordering of each unique test
  - Assessment requiring an independent historian(s)
- **⚠️ CRITICAL**: If fewer than 3 items are met, DO NOT count Category 1 at all

**Category 2: Independent Interpretation**
- Independent interpretation of tests performed by another physician/qualified healthcare professional (not separately reported)

**Category 3: External Discussion**
- Discussion of management or test interpretation with external physician/qualified healthcare professional/appropriate source (not separately reported)

---

### STEP 3: LOW COMPLEXITY
**Requires ≥1 category from the following 2:**

**Category 1: Tests and Documents**
- **MINIMUM REQUIREMENT**: Must have ANY combination of **EXACTLY 2 OR MORE** from:
  - Review of prior external note(s) from each unique source
  - Review of the result(s) of each unique test
  - Ordering of each unique test
- **⚠️ CRITICAL**: If fewer than 2 items are met, DO NOT count Category 1 at all

**Category 2: Independent Historian**
- Assessment requiring an independent historian(s)

---

### STEP 4: STRAIGHTFORWARD COMPLEXITY
**Requires ANY ONE of the following:**
- Review of prior external note(s) from each unique source
- Review of the result(s) of each unique test
- Ordering of each unique test
- **OR** No data review/analysis documented

---

## EVALUATION PROTOCOL

### Phase 1: Count Elements
For each complexity level, systematically count:
1. **External notes reviewed** (count unique sources only)
2. **Test results reviewed** (count unique tests only)
3. **Tests ordered** (count unique tests only)
4. **Independent historian assessments**
5. **Independent interpretations**
6. **External discussions**

### Phase 2: Apply Category Rules
For each level, check if categories meet minimum thresholds:
- **High/Moderate Category 1**: Needs ≥3 elements
- **Low Category 1**: Needs ≥2 elements
- **Straightforward**: Needs ≥1 element

### Phase 3: Determine Qualifying Levels
- Count qualifying categories for each level
- Apply minimum category requirements:
  - **High**: ≥2 categories
  - **Moderate**: ≥1 category
  - **Low**: ≥1 category
  - **Straightforward**: Any single element OR no documentation

### Phase 4: Report All Qualifying Levels
List ALL levels that meet requirements, with highest level first.

---

## VALIDATION CHECKLIST
- [ ] Distinct sources verified (no duplicates counted)
- [ ] Minimum thresholds strictly enforced
- [ ] Only explicitly documented items counted
- [ ] All qualifying levels identified
- [ ] Proper justification provided for each level

---

## EDGE CASE PROTOCOLS

### Duplicate Handling
- Same test multiple times → Count as 1 unique test
- Same external source multiple times → Count as 1 unique source

### Documentation Requirements
- "Reviewed outside records" → Requires specific source identification
- "Lab results reviewed" → Must specify which tests
- Implied review without explicit statement → Do not count

---

## REQUIRED OUTPUT FORMAT

```json
{
  "qualifying_levels": [
    {
      "level": "High Complexity",
      "qualified": true,
      "categories_met": 2,
      "categories_required": 2,
      "category_details": {
        "category_1": {
          "qualified": true,
          "elements_found": 4,
          "elements_required": 3,
          "elements": [
            "Review of prior external notes: 2 unique sources",
            "Review of test results: 1 unique test", 
            "Tests ordered: 1 unique test"
          ]
        },
        "category_2": {
          "qualified": true,
          "elements": ["Independent interpretation of external EKG"]
        }
      },
      "justification": "Patient case involves review of external cardiology notes and ED records (2 sources), CBC results reviewed, chest X-ray ordered, plus independent EKG interpretation.",
      "supporting_documentation": "As documented in Assessment & Plan section"
    }
  ],
  "elements_inventory": {
    "external_notes_reviewed": 2,
    "test_results_reviewed": 1,
    "tests_ordered": 1,
    "independent_historian": 0,
    "independent_interpretations": 1,
    "external_discussions": 0
  }
}
```

## CRITICAL REMINDERS
1. **NO PARTIAL CREDIT**: 2 out of 3 required elements = Category 1 DOES NOT QUALIFY
2. **COUNT ALL LEVELS**: A case can qualify for multiple levels simultaneously
3. **EXPLICIT DOCUMENTATION ONLY**: "Patient had prior workup" ≠ "Reviewed external cardiology note from Dr. Smith dated 1/15/24"
4. **UNIQUE SOURCES/TESTS ONLY**: Multiple CBCs = 1 test type

'''
